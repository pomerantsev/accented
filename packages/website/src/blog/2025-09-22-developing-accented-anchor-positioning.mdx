---
title: "Developing Accented: anchor positioning"
description: TODO
author: Pavel Pomerantsev
---
import { Image } from 'astro:assets';
import exampleImg from '~/assets/images/blog-anchor-positioning-example.png';

In this post, I'll talk about:
- the positioning challenges of Accented.
- how anchor positioning solves those challenges.
- what's the fallback for non-supporting browsers.
  - tell more about Safari, how it works, but not really.

## The positioning challenge

For every element with accessibility issues, Accented inserts a button into the DOM,
which the user can click to open a dialog with issue details.

<Image
  src={exampleImg}
  alt="TODO"
  layout="constrained"
/>

The question is, how do we position that trigger button?

Remember, Accented can’t make any assumptions about the element with issues:

- It can be large or small.
- It can be anywhere in the DOM hierarchy.
- It can be any type of element: `<p>`, `<button>`, `<input>`, `<dialog>`, `<svg>`, you name it.
- It can have a position of `static`, `relative`, `absolute`, `fixed`, or `sticky`.
- It can happen to be inside a scrollable container.

In all of those scenarios,
the user should be able to find the trigger button easily and interact with it.

## DOM structure

The first part of the challenge is where to put the button in the DOM.

- Should it live inside the element with issues?
- Should it be a sibling of the element with issues?
- Should all the trigger buttons live inside a dedicated container?

The main issue with option 1 (inside the element) is that some elements can’t have children at all, for example, `<img>` or `<input>`.
Also, adding the button would invalidate some types of issues —
for example, the “empty button” issue would no longer be an issue if we inserted an Accented’s trigger button into it.

I ruled out option 3 (a dedicated container) primarily because of the focus order problem:
the trigger buttons would all come before or after the rest of the content in focus order,
and that seemed to be a non-ideal UX.
And there’s [a problem with modal dialogs](https://github.com/whatwg/html/issues/9936) too:
with such a setup, trigger buttons on elements inside a modal dialog simply wouldn’t work.

This leaves us with option 2: each trigger button sits next to the element that it’s associated with.

Now we’re getting to the actual positioning part.
How do we ensure that the trigger button is always at the top right (for left-to-right languages) of the element it is associated with?

## Fixed and absolute positioning

So if we don't consider anchor positioning, we have two options:
- absolute positioning. We position the element relative to the closest scrollable container.
  - No way to properly position triggers on elements with `position: sticky` (because those exhibit the behaviors of both static and fixed positioning).
- fixed positioning.
  - the `position: sticky` issue is not an issue any longer, but now we need to update the position on scroll.

## How anchor positioning helps

TODO: research how the behavior of an element with anchor positioning should be different _according to the spec_ if it has `position: fixed` or `position: absolute`.

Now with anchor positioning, we can, as the name suggests, anchor the trigger to the element with issues.
TODO: talk in detail about anchor positioning.
Which means that we're free to place the element in the dom wherever we want (including as a sibling of the element with issues),
and the trigger will still be positioned correctly.
- It requires much less code.

## Caveats
- We need to update the value of `anchor-name` on the element with issues.
  We try to be careful and not break any existing styles (for example, we do XYZ),
  but it's hardly possible to be 100% safe.

## Browser support
- Anchor positioning is still not supported in all browsers that Accented supports.
  - It's completely unsupported in Firefox.
  - In Safari, support was added very recently (version 26.0), but the implementation has a bug which prevents all the tests in Accented from passing.
  - In non-supporting browsers, we fall back to fixed positioning with scroll event listener.

## Bonus: logical properties
While not directly related to anchor positioning,
we use logical [CSS logical properties and values](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_logical_properties_and_values)
throughout the codebase.
This has a particular benefit: it's RTL support (TODO: add screenshots).

## Closing thoughts.
Anchor positioning is cool, and it's very helpful in some scenarios, but we still can't use it without providing a fallback.
